generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CanonicalStatus {
  CREATED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  DELAYED
  ACTION_REQUIRED
  FAILURE
}

enum PlanTier {
  free
  starter
  professional
  business
  enterprise
}

enum NotificationMethod {
  EMAIL
  SMS
}

enum NotificationFrequency {
  REAL_TIME
  DAILY_SUMMARY
  OUT_FOR_DELIVERY_ONLY
}

model User {
  id         String   @id @default(uuid())
  email      String?  @unique
  plan       PlanTier @default(free)
  quotaMonth Int      @default(20)
  locale     String?
  tz         String?
  createdAt  DateTime @default(now())

  orders         Order[]
  loyaltyEntries LoyaltyLedger[]
  shipments      Shipment[]
  usageMeters    UsageMeter[]
  consents       Consent[]
  savedAddresses SavedAddress[]
  orders                  Order[]
  loyaltyEntries          LoyaltyLedger[]
  shipments               Shipment[]
  usageMeters             UsageMeter[]
  consents                Consent[]
  notificationPreferences NotificationPreference[]
}

model UsageMeter {
  id               BigInt   @id @default(autoincrement())
  userId           String
  periodStart      DateTime @db.Date
  shipmentsTracked Int      @default(0)

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, periodStart])
  @@index([userId])
}

model Carrier {
  id        String @id @default(uuid())
  code      String @unique
  name      String
  apiSource String

  shipments      Shipment[]
  trackingChains TrackingChain[]
}

model Order {
  id           String   @id @default(uuid())
  userId       String
  merchantName String?
  orderNumber  String?
  currency     String?
  totalAmount  Decimal?
  source       String
  createdAt    DateTime @default(now())

  user      User       @relation(fields: [userId], references: [id])
  shipments Shipment[]
}

model Shipment {
  id             String          @id @default(uuid())
  orderId        String?
  carrierId      String?
  userId         String?
  label          String?
  trackingNumber String
  status         CanonicalStatus @default(CREATED)
  eta            DateTime?
  origin         String?
  originLat      Float?
  originLng      Float?
  destination    String?
  destinationLat Float?
  destinationLng Float?
  currentLat     Float?
  currentLng     Float?
  lastEventAt    DateTime?
  createdAt      DateTime        @default(now())

  order                Order?          @relation(fields: [orderId], references: [id])
  carrier              Carrier?        @relation(fields: [carrierId], references: [id])
  user                 User?           @relation(fields: [userId], references: [id])
  events               TrackingEvent[]
  chainLinks           TrackingChain[]
  loyalty              LoyaltyLedger[]
  orderNumberEncrypted String?
  deliveryNotes        String?
  deliveryPhotos       DeliveryPhoto[]
  carbonFootprintKg    Float?

  @@index([trackingNumber])
  @@index([userId])
}

model TrackingChain {
  id             BigInt   @id @default(autoincrement())
  shipmentId     String
  carrierId      String?
  trackingNumber String
  handoffIndex   Int
  isCurrent      Boolean  @default(false)
  createdAt      DateTime @default(now())

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  carrier  Carrier? @relation(fields: [carrierId], references: [id])

  @@unique([shipmentId, carrierId, trackingNumber])
  @@index([shipmentId])
  @@index([shipmentId, isCurrent])
}

model StatsRollup {
  ts                 DateTime @id
  shipmentsPerMinute Int
  shipmentsPerHour   Int
  shipmentsToday     Int
  shipmentsWeek      Int
  mau                Int
}

model TrackingEvent {
  id              BigInt          @id @default(autoincrement())
  shipmentId      String
  carrierStatus   String?
  canonicalStatus CanonicalStatus
  location        String?
  eventTime       DateTime
  payload         Json?

  shipment Shipment @relation(fields: [shipmentId], references: [id])

  @@index([shipmentId])
}

model LoyaltyLedger {
  id         BigInt   @id @default(autoincrement())
  userId     String
  shipmentId String
  points     Int
  reason     String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  shipment Shipment @relation(fields: [shipmentId], references: [id])

  @@unique([userId, shipmentId, reason])
  @@index([userId])
}

model Coupon {
  id          String    @id @default(uuid())
  partnerCode String
  couponCode  String    @unique
  pointsCost  Int
  expiresAt   DateTime?
  metadata    Json?
  redeemedBy  String?
  redeemedAt  DateTime?
}

model Consent {
  id            String   @id @default(uuid())
  userId        String
  consentType   String   // e.g., 'email_scanning', 'data_processing', 'marketing'
  granted       Boolean  @default(false)
  grantedAt     DateTime?
  revokedAt     DateTime?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, consentType])
  @@index([userId])
  @@index([consentType, granted])
}

model NotificationPreference {
  id        String                 @id @default(uuid())
  userId    String
  methods   NotificationMethod[]
  frequency NotificationFrequency  @default(REAL_TIME)
  enabled   Boolean                @default(true)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([userId])
model SavedAddress {
  id           String   @id @default(uuid())
  userId       String
  nickname     String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String
  country      String
  lat          Float?
  lng          Float?
  instructions String?  // e.g., "Leave at front desk", "Gate code: 1234"
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
}

model DeliveryPhoto {
  id          String   @id @default(uuid())
  shipmentId  String
  photoUrl    String
  photoType   String   // e.g., "proof_of_delivery", "package_condition", "location"
  uploadedBy  String?  // userId or "carrier"
  uploadedAt  DateTime @default(now())
  metadata    Json?

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId])
}

model DeliveryPreferences {
  id                  String   @id @default(uuid())
  userId              String   @unique
  defaultInstructions String?
  preferredTimeStart  String?  // e.g., "09:00"
  preferredTimeEnd    String?  // e.g., "17:00"
  allowReschedule     Boolean  @default(true)
  allowRedirect       Boolean  @default(true)
  notifyOnDispatch    Boolean  @default(true)
  notifyOnDelivery    Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId])
model NotificationPreference {
  id         String   @id @default(uuid())
  userId     String
  method     String   // 'email', 'push', 'webhook', 'sms'
  frequency  String   // 'realtime', 'daily', 'weekly', 'never'
  enabled    Boolean  @default(true)
  metadata   Json?    // extensible field for method-specific config (e.g., webhook URLs)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, method])
  @@index([userId])
  @@index([userId, enabled])
}
